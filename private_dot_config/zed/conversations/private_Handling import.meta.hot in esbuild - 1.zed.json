{"id":"16738d40-c5b2-4334-a8bc-07f2be446a0e","zed":"context","version":"0.4.0","text":"\n\n\n```ts solv-monorepo/apps/sunscreen/api/src/main.ts\nimport 'zod-openapi/extend'\nimport './init/install-datadog-trace'\nimport './init/include-deps'\n\nimport type { Server } from 'http'\nimport { join } from 'path'\nimport { createExpressMiddleware } from '@trpc/server/adapters/express'\nimport bodyParser from 'body-parser'\nimport chalk from 'chalk'\nimport compression from 'compression'\nimport cookieSession from 'cookie-session'\nimport express, { type Express } from 'express'\nimport helmet from 'helmet'\nimport passport from 'passport'\nimport swaggerUi from 'swagger-ui-express'\nimport {\n  createOpenApiHttpHandler,\n  generateOpenApiDocument,\n} from 'trpc-to-openapi'\n\nimport { prefetchSsmParams } from '@solv/shared-prefetch-ssm-params'\nimport { apiWorkerRunnerService } from '@solv/sunscreen-api-api-worker-tasks-runner'\nimport {  env, readyServer, ssmParams } from '@solv/sunscreen-api-core'\nimport { startCronService } from '@solv/sunscreen-api-cron'\nimport { runPendingDataMigrations } from '@solv/sunscreen-api-data-migrations'\nimport {\n  createTrpcContext,\n  trpcApiRouter,\n  type TrpcApiRouter,\n} from '@solv/sunscreen-api-trpc'\nimport { userManualApi } from '@solv/sunscreen-api-user-manual'\nimport { authSsoApi } from '@solv/sunscreen-api-users'\nimport { startVitalsDataProcessingItemPolling } from '@solv/sunscreen-api-vitals-platform'\n\nimport { environment } from './environments/environment'\n\nconst globalPrefix = 'api'\n\nlet server: Server\nconst port = env.PORT || 3333\n\nasync function bootstrap() {\n  await prefetchSsmParams(ssmParams)\n  readyServer()\n\n  const app = express()\n\n  addStaticFiles(app)\n  addGzipCompression(app)\n  addSecurityPolicies(app)\n  addCookieSessions(app)\n  addRequestBodyParser(app)\n\n  addTrpc(app, trpcApiRouter)\n  addRestApiDocumentation(app, trpcApiRouter)\n\n  addUserManual(app)\n\n  addPassportSsoAuthentication(app)\n\n  void runPendingDataMigrations()\n\n  startCronService()\n  startVitalsDataProcessingItemPolling()\n\n  startWatchingForTasks()\n  startServer(app)\n}\n\nfunction addStaticFiles(app: Express) {\n  app.use(express.static(join(import.meta.dirname, '..', 'web')))\n  app.get(/^(?!\\/api\\/?)/, (req, res) => {\n    res.sendFile(join(import.meta.dirname, '..', 'web', 'index.html'))\n  })\n}\n\nfunction addGzipCompression(app: Express) {\n  app.use(compression())\n}\n\nfunction addSecurityPolicies(app: Express) {\n  app.use(helmet.dnsPrefetchControl())\n  app.use(helmet.expectCt())\n  app.use(helmet.frameguard())\n  app.use(helmet.hidePoweredBy())\n  app.use(helmet.hsts())\n  app.use(helmet.ieNoOpen())\n  app.use(helmet.noSniff())\n  app.use(helmet.permittedCrossDomainPolicies())\n  app.use(helmet.referrerPolicy())\n  app.use(helmet.xssFilter())\n}\n\nfunction addCookieSessions(app: Express) {\n  app.set('trust proxy', 1) // Allow secure cookies to be passed from the load balancer to the instances.\n  app.use(\n    cookieSession({\n      name: 'session',\n      secret: env.SESSION_SECRET,\n      maxAge: 1000 * 60 * 60 * 24 * 7,\n      secure: environment.secureCookies,\n      httpOnly: true,\n    }),\n  )\n}\n\nfunction addRequestBodyParser(app: Express) {\n  // Drastically increase max request size.\n  app.use(bodyParser.json({ limit: '50mb' }))\n  app.use(bodyParser.urlencoded({ limit: '50mb', extended: true }))\n}\n\n/**\n * Setup express to handle tRPC requests, and to serve the REST endpoints\n * declared by tRPC routers.\n */\nfunction addTrpc(expressApp: Express, trpcAppRouter: TrpcApiRouter): void {\n  const handlerOptions = {\n    router: trpcAppRouter,\n    createContext: createTrpcContext,\n  }\n\n  expressApp.use('/api/trpc', createExpressMiddleware(handlerOptions))\n  expressApp.use('/api/rest', createOpenApiHttpHandler(handlerOptions))\n}\n\nfunction addRestApiDocumentation(app: Express, trpcAppRouter: TrpcApiRouter) {\n  if (env.APP_ENV === 'LOCAL') return\n\n  const openApiDocument = generateOpenApiDocument(trpcAppRouter, {\n    title: 'Sunscreen REST API',\n    version: '1.0.0',\n    baseUrl: '/api/rest',\n  })\n\n  app.use('/api/docs', swaggerUi.serve, swaggerUi.setup(openApiDocument))\n}\n\nfunction addUserManual(app: Express) {\n  app.use(userManualApi)\n}\n\nfunction addPassportSsoAuthentication(app: Express) {\n  app.use(passport.initialize())\n  app.use(authSsoApi)\n}\n\nfunction startWatchingForTasks() {\n  apiWorkerRunnerService.startWatching({ isWorkerInstance: false })\n}\n\nasync function startServer(app: Express) {\n  server = app.listen(port, () => {\n    // eslint-disable-next-line no-console\n    console.log()\n\n    // eslint-disable-next-line no-console\n    console.info(\n      chalk.gray(new Date().toLocaleString()),\n      'ðŸš€',\n      chalk.green(\n        `API server started at http://localhost:${port}/${globalPrefix}`,\n      ),\n    )\n  })\n}\n\nvoid bootstrap()\n\n// Development only\n//   Enables hot reloading of server.\nif (import.meta.hot) {\n  import.meta.hot.on('vite:beforeFullReload', () => {\n    // eslint-disable-next-line no-console\n    console.info(\n      chalk.gray(new Date().toLocaleString()),\n      'ðŸ›‘',\n      chalk.green(\n        `API server stopped at http://localhost:${port}/${globalPrefix}`,\n      ),\n    )\n    server?.close()\n  })\n}\n```\n\nHow do make a esbuild handle `if (import.meta.hot)`? Ideally it would just strip that when making a production build\nTo handle the `import.meta.hot` condition and strip it out during a production build using esbuild, you can use the `esbuild-plugin-conditional-compile` plugin. This plugin allows you to conditionally include or exclude code based on environment variables.\n\nFirst, install the plugin:\n\n```sh\nnpm install esbuild-plugin-conditional-compile --save-dev\n```\n\nThen, you can configure esbuild to use this plugin in your build script. Here's an example of how you can set it up:\n\n```js\nconst esbuild = require('esbuild');\nconst conditionalCompile = require('esbuild-plugin-conditional-compile');\n\nconst isProduction = process.env.NODE_ENV === 'production';\n\nesbuild.build({\n  entryPoints: ['apps/sunscreen/api/src/main.ts'],\n  bundle: true,\n  outfile: 'dist/main.js',\n  plugins: [\n    conditionalCompile({\n      include: {\n        'import.meta.hot': !isProduction,\n      },\n    }),\n  ],\n  define: {\n    'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV),\n  },\n}).catch(() => process.exit(1));\n```\n\nIn this setup, the `conditionalCompile` plugin will include the `import.meta.hot` block only if `isProduction` is `false`. When building for production, this block will be stripped out.\n\nMake sure to set the `NODE_ENV` environment variable appropriately when running your build script:\n\n```sh\nNODE_ENV=production node build.js\n```\n\nThis way, the `import.meta.hot` block will be excluded from the production build, achieving the desired behavior.\n","messages":[{"id":{"replica_id":0,"value":0},"start":0,"metadata":{"role":"user","status":"Done","timestamp":{"replica_id":0,"value":116}}},{"id":{"replica_id":0,"value":86},"start":5217,"metadata":{"role":"assistant","status":"Done","timestamp":{"replica_id":0,"value":117}}},{"id":{"replica_id":0,"value":87},"start":6664,"metadata":{"role":"user","status":"Done","timestamp":{"replica_id":0,"value":118}}}],"summary":"Handling import.meta.hot in esbuild","slash_command_output_sections":[{"range":{"start":0,"end":1},"icon":"Library","label":"Default","metadata":null},{"range":{"start":3,"end":5099},"icon":"File","label":"solv-monorepo/apps/sunscreen/api/src/main.ts","metadata":{"path":"solv-monorepo/apps/sunscreen/api/src/main.ts"}}]}